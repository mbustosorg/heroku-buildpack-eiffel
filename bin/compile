#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -x

mktmpdir() {
  dir=$(mktemp -t node-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# parse and derive params
#EC_PLATFORM=macosx-x86-64
EC_PLATFORM=linux-x86-64
EC_ARCHIVE=Eiffel_14.05_gpl_95417-$EC_PLATFORM.tar.bz2
EC_BUILD=http://sourceforge.net/projects/eiffelstudio/files/EiffelStudio%2014.05/Build_95417/
BUILDPACK_DIR=$(cd $(dirname $0); cd ..; pwd) # absolute path of buildpack
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> compile params: $BUILD_DIR $CACHE_DIR $ENV_DIR"

if [ $RESET_CACHE ]; then
  echo "-----> flushing cache"
  rm -rf $CACHE_DIR/*
fi

EC_DIR="$CACHE_DIR/estudio"

echo "-----> Installing Eiffel Compiler"
if [ ! -d $EC_DIR ]; then
    echo "-----> Fetching Eiffel Compiler"
    mkdir -p $EC_DIR
	curl -L -O $EC_BUILD$EC_ARCHIVE 
	tar jxf $EC_ARCHIVE -C $EC_DIR
	rm -rf $EC_ARCHIVE
	cp $EC_DIR $BUILD_DIR
fi

ISE_EIFFEL=$EC_DIR/Eiffel_14.05
ISE_PLATFORM=$EC_PLATFORM
PATH=$ISE_EIFFEL/studio/spec/$ISE_PLATFORM/bin:$PATH

echo "Eiffel Compiler installed" | indent

echo "-----> Compiling"
EC_CONFIG=$(find $BUILD_DIR -maxdepth 1 -name "*.ecf" -print -quit | head -n 1)
EC_TARGET=$(sed -n 's/.*target name="\([A-z]*\).*/\1/p' <$EC_CONFIG | head -n 1)

echo "-----> Compiling $EC_CONFIG for target $EC_TARGET"

export ISE_EIFFEL
export ISE_PLATFORM

EC_TARGET=restbucks
ec -finalize -config $EC_CONFIG -target $EC_TARGET
#EWF_LS=$(pwd)
#EWF_LS=$(ls EIFGENs/restbucks/F_code)
#EWF_LS=$(find / -name "finish_freezing")
#$BUILD_DIR/EIFGENs/F_Code/finish_freezing
cd /app/tmp/repo.git/EIFGENs/$EC_TARGET/F_code
finish_freezing
cp /app/tmp/repo.git/EIFGENs/$EC_TARGET/F_code/$EC_TARGET $BUILD_DIR

#mkdir $CACHE_DIR/repos	     	      # should be under an if to avoid error
#pushd $CACHE_DIR/repos

#if [ -d $CACHE_DIR/repos/portableaserve ]; then
#     echo 'aserve already present'
#     pushd portableaserve
#     git pull origin master
#     popd
#else 
#    git clone git://github.com/mtravers/portableaserve.git
#fi

#if [ -d $CACHE_DIR/repos/wuwei ]; then
#     echo 'wuwei already present'
#     pushd wuwei
#    git pull origin master
#     popd
#else 
#    git clone git://github.com/mtravers/wuwei.git
#fi

#popd

#export BUILDPACK_DIR
#export CACHE_DIR
#export BUILD_DIR
#export CCL_DEFAULT_DIRECTORY=$EC_DIR

#echo "-----> Starting build"
#$CCL_DEFAULT_DIRECTORY/scripts/ccl64 -l "$BUILDPACK_DIR/setup/compile.lisp"
#echo "-----> Build finished"

#chmod a+x $BUILD_DIR/lispapp